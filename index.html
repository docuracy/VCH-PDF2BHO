<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VCH XHTML Editor</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <!-- Bootstrap for modal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SaxonJS for XSLT 3.0 transformation -->
    <script src="./xhtml-view/js/SaxonJS2.rt.js"></script>
    <!-- vkBeautify for XML formatting (inline to avoid CDN issues) -->
    <script>
        /**
         * vkBeautify - javascript plugin to pretty-print or minify text in XML, JSON, CSS and SQL formats.
         * Version - 0.99.00.beta
         * http://www.eslinstructor.net/vkbeautify/
         * Copyright (c) 2012 Vadim Kiryukhin
         * Dual licensed under the MIT and GPL licenses
         */
        (function () {
            function createShiftArr(step) {
                var space = '    ';
                if (isNaN(parseInt(step))) {
                    space = step;
                } else {
                    switch (step) {
                        case 1:
                            space = ' ';
                            break;
                        case 2:
                            space = '  ';
                            break;
                        case 3:
                            space = '   ';
                            break;
                        case 4:
                            space = '    ';
                            break;
                        case 5:
                            space = '     ';
                            break;
                        case 6:
                            space = '      ';
                            break;
                        case 7:
                            space = '       ';
                            break;
                        case 8:
                            space = '        ';
                            break;
                        case 9:
                            space = '         ';
                            break;
                        case 10:
                            space = '          ';
                            break;
                        case 11:
                            space = '           ';
                            break;
                        case 12:
                            space = '            ';
                            break;
                    }
                }
                var shift = ['\n'];
                for (var ix = 0; ix < 100; ix++) {
                    shift.push(shift[ix] + space);
                }
                return shift;
            }

            function vkbeautify() {
                this.step = '    ';
                this.shift = createShiftArr(this.step);
            };

            vkbeautify.prototype.xml = function (text, step) {
                var ar = text.replace(/>\s{0,}</g, "><")
                        .replace(/</g, "~::~<")
                        .replace(/\s*xmlns\:/g, "~::~xmlns:")
                        .replace(/\s*xmlns\=/g, "~::~xmlns=")
                        .split('~::~'),
                    len = ar.length,
                    inComment = false,
                    deep = 0,
                    str = '',
                    ix = 0,
                    shift = step ? createShiftArr(step) : this.shift;

                for (ix = 0; ix < len; ix++) {
                    if (ar[ix].search(/<!/) > -1) {
                        str += shift[deep] + ar[ix];
                        inComment = true;
                        if (ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1 || ar[ix].search(/!DOCTYPE/) > -1) {
                            inComment = false;
                        }
                    } else if (ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1) {
                        str += ar[ix];
                        inComment = false;
                    } else if (/^<\w/.exec(ar[ix - 1]) && /^<\/\w/.exec(ar[ix]) &&
                        /^<[\w:\-\.\,]+/.exec(ar[ix - 1]) == /^<\/[\w:\-\.\,]+/.exec(ar[ix])[0].replace('/', '')) {
                        str += ar[ix];
                        if (!inComment) deep--;
                    } else if (ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) == -1 && ar[ix].search(/\/>/) == -1) {
                        str = !inComment ? str += shift[deep++] + ar[ix] : str += ar[ix];
                    } else if (ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) > -1) {
                        str = !inComment ? str += shift[deep] + ar[ix] : str += ar[ix];
                    } else if (ar[ix].search(/<\//) > -1) {
                        str = !inComment ? str += shift[--deep] + ar[ix] : str += ar[ix];
                    } else if (ar[ix].search(/\/>/) > -1) {
                        str = !inComment ? str += shift[deep] + ar[ix] : str += ar[ix];
                    } else if (ar[ix].search(/<\?/) > -1) {
                        str += shift[deep] + ar[ix];
                    } else if (ar[ix].search(/xmlns\:/) > -1 || ar[ix].search(/xmlns\=/) > -1) {
                        str += shift[deep] + ar[ix];
                    } else {
                        str += ar[ix];
                    }
                }
                return (str[0] == '\n') ? str.slice(1) : str;
            }

            window.vkbeautify = new vkbeautify();
        })();
    </script>
    <!-- Editor styles -->
    <link rel="stylesheet" href="./css/editor.css">
</head>
<body>

<div id="top-bar">
    <div id="file-input-container">
        <select id="template-selector" title="Select from Template or Example, or choose your own file">
            <option value="template.xhtml">Template</option>
            <option value="example.xhtml">Example</option>
        </select>
        <input type="file" id="file-input" accept=".xml,.xhtml,.html,.txt,.pdf" style="display: none;">
        <label for="file-input" id="file-input-label" title="Upload your own XHTML or PDF file">
            <span class="file-button">Choose File</span>
            <span id="file-name">template.xhtml</span>
        </label>
    </div>
    <div id="tabs">
        <button id="edit-tab" class="active">
            <img src="./images/VCH.jpeg" class="institution-icon">
            Edit
            <span class="download-icon" id="download-xml-icon" title="Save as XHTML">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 12L3 7h3V1h4v6h3L8 12z"/>
                    <path d="M14 13v2H2v-2H0v2a2 2 0 002 2h12a2 2 0 002-2v-2h-2z"/>
                </svg>
            </span>
        </button>
        <button id="preview-tab">
            <img src="./images/BHO.png" class="institution-icon">
            Validate & Preview
            <span class="download-icon" id="download-html-icon" title="Save as HTML">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 12L3 7h3V1h4v6h3L8 12z"/>
                    <path d="M14 13v2H2v-2H0v2a2 2 0 002 2h12a2 2 0 002-2v-2h-2z"/>
                </svg>
            </span>
            <span class="convert-icon" id="convert-to-bho-btn" title="Save as BHO XML">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="5,2 2,8 5,14"/>
                    <polyline points="11,2 14,8 11,14"/>
                </svg>
            </span>
        </button>
    </div>
    <a id="doc-btn" href="https://github.com/docuracy/VCH-PDF2BHO?tab=readme-ov-file#top"
       target="_blank">
        Documentation
    </a>
    <button id="format-btn" onclick="formatDocument()" title="Format Document (add indentation)"
            style="margin: 4px; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"
             style="vertical-align: text-bottom; margin-right: 4px;">
            <path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm2-1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/>
            <path d="M4 5h8v1H4V5zm0 2h8v1H4V7zm0 2h6v1H4V9z"/>
        </svg>
        Format
    </button>
    <span id="validation-result"></span>
</div>

<div id="edit-container">
    <div id="xhtml-editor"></div>
</div>

<div id="preview-container" style="display:none">
    <iframe id="preview-frame"></iframe>
</div>

<div class="modal fade" id="notification-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center shadow-sm">
            <div class="modal-body py-4">
                <div class="mb-2">
                    <svg width="32" height="32" viewBox="0 0 16 16" fill="#198754">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                    </svg>
                </div>
                <h6 class="modal-title mb-1" id="notification-title">Session Restored</h6>
                <p class="small text-muted mb-0" id="notification-message">Your unsaved work has been recovered.</p>
            </div>
        </div>
    </div>
</div>

<!-- PDF Extraction Modal -->
<div class="modal fade" id="pdf-extraction-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Extracting PDF to XHTML</h5>
            </div>
            <div class="modal-body">
                <div class="extraction-progress">
                    <div class="progress">
                        <div id="extraction-progress-bar"
                             class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                             aria-valuemax="100"></div>
                    </div>
                    <div id="extraction-status">Initializing...</div>
                </div>
                <div id="extraction-log">
                    <p><strong>Processing Log:</strong></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="extraction-close" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="display:none">Close
                </button>
                <button type="button" id="extraction-load" class="btn btn-primary" style="display:none">Load in Editor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Dependencies: jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.min.js"></script>
<!-- LZ-String -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<!-- Simple Statistics (required by imaging.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.8.0/simple-statistics.min.js"></script>

<!-- Load standalone utilities (no jQuery) -->
<script src="utilities-standalone.js"></script>

<!-- Load PDF processing scripts (non-module) -->
<script src="js/imaging.js"></script>
<script src="js/text.js"></script>
<script src="js/pdf.js"></script>

<!-- Main editor script (module) -->
<script type="module" src="./js/editor/main-integrated.js"></script>

</body>
</html>